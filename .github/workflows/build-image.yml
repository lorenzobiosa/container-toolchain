# ------------------------------------------------------------------------------------
# Build & Release Toolchain Builder
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> Â© Biosa Labs
# Description:
# End-to-end CI/CD workflow that:
#  - Builds and pushes an AMD64 image to GHCR for EL9 and EL10
#  - Runs vulnerability scans (Trivy + Grype) and uploads SARIF reports to Code Scanning
#  - Signs and verifies images using Cosign (keyless via GitHub OIDC)
#  - Exports SBOMs (SPDX JSON) as workflow artifacts
#  - Replicates verified images to Docker Hub via Buildx imagetools (by digest)
#
# Requirements:
#  - Repository Secret: DOCKERHUB_TOKEN       (Docker Hub access token)
#  - Repository Variable: DOCKERHUB_USERNAME  (non-sensitive)
#
# Notes:
#  - Least-privilege permissions at workflow level.
#  - Concurrency prevents overlapping runs for the same ref.
#  - All stages after build call reusable workflows; no duplication here.
# ------------------------------------------------------------------------------------

name: Build & Release Toolchain Builder

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - docker/builder/Dockerfile
      - configs/prompt/**
      - .github/workflows/build-image.yml

permissions:
  contents: write
  packages: write
  id-token: write
  security-events: write

concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }} # non-sensitive
  IMAGE_NAME: ghcr.io/lorenzobiosa/toolchain-builder
  DOCKERFILE: docker/builder/Dockerfile
  CONTEXT: .
  PLATFORMS: linux/amd64
  TITLE: UBI Container Toolchain Builder
  DESCRIPTION: Deterministic builder (amd64 toolchains) with parametric sysroots
  VENDOR: Biosa Labs
  LICENSES: MIT

jobs:
  # 0) Prepare matrix once and reuse in all subsequent jobs
  variants:
    name: Prepare build variants matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        run: |
          cat > /tmp/matrix.json <<'JSON'
          {"variant":[
            {"tag":"el9","base_image":"registry.access.redhat.com/ubi9/ubi:latest"},
            {"tag":"el10","base_image":"registry.access.redhat.com/ubi10/ubi:latest"}
          ]}
          JSON

          {
            echo 'matrix<<EOF'
            cat /tmp/matrix.json
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  # 1) Build & push to GHCR (amd64) per variant
  build:
    name: Build & Push (GHCR) - ${{ matrix.variant.tag }}
    runs-on: ubuntu-latest
    needs: [variants]
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.variants.outputs.matrix) }}
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR (write)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & Push image (amd64) to GHCR
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/builder/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ghcr.io/lorenzobiosa/toolchain-builder:${{ matrix.variant.tag }}
          build-args: |
            BASE_IMAGE=${{ matrix.variant.base_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 2) Vulnerability scan with Trivy (gating + SARIF) per variant
  scan_trivy:
    name: Scan (Trivy) - ${{ matrix.variant.tag }} (HIGH/CRITICAL + SARIF)
    needs: [variants, build]
    strategy:
      matrix: ${{ fromJSON(needs.variants.outputs.matrix) }}
    uses: ./.github/workflows/scan-trivy.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:${{ matrix.variant.tag }}
      fail_on: HIGH,CRITICAL
      output_sarif: true
    secrets: inherit

  # 3) Vulnerability scan with Grype (gating + SARIF) per variant
  scan_grype:
    name: Scan (Grype) - ${{ matrix.variant.tag }} (HIGH + SARIF)
    needs: [variants, build]
    strategy:
      matrix: ${{ fromJSON(needs.variants.outputs.matrix) }}
    uses: ./.github/workflows/scan-grype.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:${{ matrix.variant.tag }}
      fail_on: high
    secrets: inherit

  # 4) Sign & verify with Cosign (keyless OIDC) per variant
  sign:
    name: Cosign sign & verify (keyless) - ${{ matrix.variant.tag }}
    needs: [variants, scan_trivy, scan_grype]
    strategy:
      matrix: ${{ fromJSON(needs.variants.outputs.matrix) }}
    uses: ./.github/workflows/sign-verify.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:${{ matrix.variant.tag }}
      digest: ${{ needs.build.outputs.digest }}
      workflow_file: .github/workflows/sign-verify.yml
    secrets: inherit

  # 5) SBOM (SPDX JSON) artifact per variant
  sbom:
    name: SBOM (SPDX JSON) - ${{ matrix.variant.tag }}
    needs: [variants, sign]
    strategy:
      matrix: ${{ fromJSON(needs.variants.outputs.matrix) }}
    uses: ./.github/workflows/sbom-export.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:${{ matrix.variant.tag }}
      artifact_name: sbom-${{ matrix.variant.tag }}.spdx.json
      output_file: sbom-${{ matrix.variant.tag }}.spdx.json
    secrets: inherit

  # 6) Replicate the verified image to Docker Hub (by digest) per variant
  replicate_dockerhub:
    name: Replicate to Docker Hub - ${{ matrix.variant.tag }}
    needs: [variants, sbom]
    strategy:
      matrix: ${{ fromJSON(needs.variants.outputs.matrix) }}
    uses: ./.github/workflows/replicate-to-dockerhub.yml
    with:
      ghcr_image: ghcr.io/lorenzobiosa/toolchain-builder
      dockerhub_image: docker.io/${{ vars.DOCKERHUB_USERNAME }}/toolchain-builder
      dockerhub_username: ${{ vars.DOCKERHUB_USERNAME }}
      tag: ${{ matrix.variant.tag }}
      digest: ${{ needs.build.outputs.digest }}
    secrets: inherit

  # 7) Promotion with approvals (single gate after both variants)
  promote:
    name: Promote to release (manual gate)
    runs-on: ubuntu-latest
    needs: [replicate_dockerhub]
    environment: "release"
    steps:
      - run: |
          echo "Promoting images:"
          echo "  GHCR:       ghcr.io/lorenzobiosa/toolchain-builder:el9 and :el10"
          echo "  Docker Hub: docker.io/${{ vars.DOCKERHUB_USERNAME }}/toolchain-builder:el9 and :el10"
          echo "'latest' points to :el10"
          echo "Approved deployment to 'release' environment."
