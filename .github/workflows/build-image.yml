# .github/workflows/build-builder-image.yml
name: Build & Release Toolchain Builder

on:
  workflow_dispatch:
  push:
    branches: ["master"]
    paths:
      - "docker/builder/Dockerfile"
      - "configs/prompt/**"
      - ".github/workflows/build-builder-image.yml"

jobs:
  build-push:
    name: Build & Push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # needed to push to GHCR
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ghcr.io/lorenzobiosa/ubi9-toolchain-builder
      BASE_IMAGE: registry.access.redhat.com/ubi10/ubi:latest
      IMAGE_TITLE: UBI Container Toolchain Builder
      IMAGE_DESCRIPTION: Deterministic builder (amd64/arm64 toolchains) with parametric sysroots
      IMAGE_VENDOR: Biosa Labs
      IMAGE_LICENSES: MIT

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute build metadata
        id: meta
        run: |
          set -euo pipefail
          echo "revision=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"
          echo "version=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Validate prompt files present
        run: |
          set -euo pipefail
          test -f configs/prompt/00-welcome.sh || { echo "::error ::Missing configs/prompt/00-welcome.sh"; exit 1; }
          test -f configs/prompt/10-ps1.sh     || { echo "::error ::Missing configs/prompt/10-ps1.sh"; exit 1; }

      # Build single-arch image (amd64 runner), then push
      - name: Docker Build
        run: |
          set -euo pipefail
          docker build \
            --file docker/builder/Dockerfile \
            --tag "${{ env.IMAGE_NAME }}:latest" \
            --build-arg BASE_IMAGE="${{ env.BASE_IMAGE }}" \
            --build-arg VCS_REF="${{ steps.meta.outputs.revision }}" \
            --build-arg BUILD_DATE="${{ steps.meta.outputs.created }}" \
            --build-arg IMAGE_VERSION="${{ steps.meta.outputs.version }}" \
            .

      - name: Docker Push
        run: |
          set -euo pipefail
          docker push "${{ env.IMAGE_NAME }}:latest"
