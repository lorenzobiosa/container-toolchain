# ------------------------------------------------------------------------------------
# Build & Release Toolchain Builder (Enterprise)
# ------------------------------------------------------------------------------------
# Description:
# End-to-end, production-grade CI workflow that:
#  - Builds and pushes a multi-arch image to GHCR with SLSA provenance and SBOM attestation
#  - Runs vulnerability scans (Trivy + Grype) and uploads SARIF reports to Code Scanning
#  - Signs and verifies the image using Cosign (keyless via GitHub OIDC)
#  - Exports a standalone SBOM (SPDX JSON) as a workflow artifact
#  - Replicates the verified image to Docker Hub (post-scan gate) via Buildx imagetools
#  - Supports environment-based promotion with manual approvals (GitHub Environments)
#
# Requirements:
#  - Repository VAR:    DOCKERHUB_USERNAME   (non-sensitive)
#  - Repository SECRET: DOCKERHUB_TOKEN     (Docker Hub access token)
#  - Reusable workflows present under .github/workflows/:
#      build-container.yml, scan-trivy.yml, scan-grype.yml,
#      sign-verify.yml, sbom-export.yml, replicate-to-dockerhub.yml
# ------------------------------------------------------------------------------------

name: Build & Release Toolchain Builder (Enterprise)

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - docker/builder/Dockerfile
      - configs/prompt/**
      - .github/workflows/build-image.yml

# Least-privilege permissions needed for this workflow
permissions:
  contents: write # artifacts, SBOM uploads
  packages: write # push to GHCR
  id-token: write # Cosign keyless (OIDC)
  security-events: write # SARIF uploads to Code Scanning

# Prevent overlapping runs for the same ref (best practice)
concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1) Build & push to GHCR (SLSA provenance + SBOM attestation)
  build:
    name: Build & Push (GHCR) + provenance/SBOM attestation
    uses: ./.github/workflows/build-container.yml
    with:
      base: registry.access.redhat.com/ubi10/ubi:latest
      tag: ubi10
      image_name: ghcr.io/lorenzobiosa/toolchain-builder
      title: UBI Container Toolchain Builder
      description: Deterministic builder (amd64/arm64 toolchains) with parametric sysroots
      vendor: Biosa Labs
      licenses: MIT

  # 2) Vulnerability scans (Trivy + Grype) with SARIF uploads (gating)
  scan_trivy:
    name: Scan (Trivy) - gate HIGH/CRITICAL + SARIF
    needs:
      - build
    uses: ./.github/workflows/scan-trivy.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:ubi10
      fail_on: HIGH,CRITICAL
      output_sarif: true

  scan_grype:
    name: Scan (Grype) - gate HIGH + SARIF
    needs:
      - build
    uses: ./.github/workflows/scan-grype.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:ubi10
      fail_on: high

  # 3) Cosign: sign & verify (keyless OIDC) strictly bound to the signing workflow path
  sign:
    name: Cosign sign & verify (keyless)
    needs:
      - scan_trivy
      - scan_grype
    uses: ./.github/workflows/sign-verify.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:ubi10
      digest: ${{ needs.build.outputs.digest }}
      workflow_file: .github/workflows/sign-verify.yml

  # 4) SBOM file (SPDX JSON) in addition to registry attestation
  sbom_file:
    name: SBOM (SPDX JSON) artifact
    needs:
      - sign
    uses: ./.github/workflows/sbom-export.yml
    with:
      image_ref: ghcr.io/lorenzobiosa/toolchain-builder:ubi10
      artifact_name: sbom-ubi10.spdx.json
      output_file: sbom-ubi10.spdx.json

  # 5) Replicate the verified image to Docker Hub (post-scan gate) via Buildx imagetools
  replicate_dockerhub:
    name: Replicate to Docker Hub (post-scan gate)
    needs:
      - sbom_file
    uses: ./.github/workflows/replicate-to-dockerhub.yml
    with:
      ghcr_image: ghcr.io/lorenzobiosa/toolchain-builder
      dockerhub_image: docker.io/${{ vars.DOCKERHUB_USERNAME }}/toolchain-builder
      dockerhub_username: ${{ vars.DOCKERHUB_USERNAME }} # required by the reusable workflow
      tag: ubi10
      digest: ${{ needs.build.outputs.digest }}
    secrets: inherit # inherits DOCKERHUB_TOKEN from repository secrets

  # 6) Promotion with approvals (GitHub Environments - set reviewers/wait timers in repository Settings)
  promote:
    name: Promote to release (manual gate)
    needs:
      - replicate_dockerhub
    runs-on: ubuntu-latest
    environment: "release" # ensure 'production' exists in Settings â†’ Environments
    steps:
      - run: |
          echo "Promoting image:"
          echo "  GHCR       -> ghcr.io/lorenzobiosa/toolchain-builder:ubi10"
          echo "  Docker Hub -> docker.io/${{ vars.DOCKERHUB_USERNAME }}/toolchain-builder:ubi10"
          echo "Approved deployment to 'production' environment."
