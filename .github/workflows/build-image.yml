# .github/workflows/build-builder-image.yml
name: Build & Release Toolchain Builder

on:
  workflow_dispatch:
  push:
    branches: ["master"]
    paths:
      - "build/Dockerfile"
      - "config/prompt/**"
      - ".github/workflows/build-builder-image.yml"

jobs:
  build-push:
    name: Build & Push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # needed to push to GHCR
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ghcr.io/lorenzobiosa/ubi9-toolchain-builder
      GO_VERSION: "1.25.5"
      ENABLE_SUDO: "1"
      PROMPT_ENABLE_COLORS: "1"
      WELCOME_ENABLE: "1"
      IMAGE_TITLE: "UBI9 Container Toolchain Builder"
      IMAGE_DESCRIPTION: "UBI9-based builder with Go toolchain and ARM64 sysroot for cross-compilation of tools"
      IMAGE_VENDOR: "Lorenzo Biosa"
      IMAGE_LICENSES: "MIT"
      BASE_IMAGE: "registry.access.redhat.com/ubi9/ubi:latest"
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute build metadata
        id: meta
        run: |
          set -euo pipefail
          echo "revision=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"
          echo "version=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Validate prompt files present
        run: |
          set -euo pipefail
          test -f build/config/prompt/00-welcome.sh || { echo "::error ::Missing build/config/prompt/00-welcome.sh"; exit 1; }
          test -f build/config/prompt/10-ps1.sh     || { echo "::error ::Missing build/config/prompt/10-ps1.sh"; exit 1; }

      - name: Build & Push # multi-arch
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          file: build/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Pass Dockerfile build args so banner/prompt & sudo are parametrized at build time
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            GO_VERSION=${{ env.GO_VERSION }}
            ENABLE_SUDO=${{ env.ENABLE_SUDO }}
            PROMPT_ENABLE_COLORS=${{ env.PROMPT_ENABLE_COLORS }}
            WELCOME_ENABLE=${{ env.WELCOME_ENABLE }}
            IMAGE_TITLE=${{ env.IMAGE_TITLE }}
            IMAGE_DESCRIPTION=${{ env.IMAGE_DESCRIPTION }}
            IMAGE_VENDOR=${{ env.IMAGE_VENDOR }}
            IMAGE_LICENSES=${{ env.IMAGE_LICENSES }}
            VCS_REF=${{ steps.meta.outputs.revision }}
            BUILD_DATE=${{ steps.meta.outputs.created }}
            IMAGE_VERSION=${{ steps.meta.outputs.version }}
