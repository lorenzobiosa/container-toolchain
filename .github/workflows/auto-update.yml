# ------------------------------------------------------------------------------------
# Auto-Update Upstream Versions (PR Bot) — Enterprise Configuration
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> © Biosa Labs
# Discovers latest kubectl & rancher versions; opens PR only when values change.
# ------------------------------------------------------------------------------------

name: Auto-Update Upstream Versions (PR)

on:
  schedule:
    - cron: "0 2 * * *" # Daily 02:00 CET
  workflow_dispatch:

jobs:
  bump-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover latest kubectl
        id: kver
        shell: bash
        run: |
          set -euo pipefail
          KVER="$(curl -fsSL https://dl.k8s.io/release/stable.txt || true)"
          echo "kver=${KVER}" >> "$GITHUB_OUTPUT"

      - name: Discover latest rancher CLI release
        id: rver
        shell: bash
        run: |
          set -euo pipefail
          TAG="$(curl -fsSL https://api.github.com/repos/rancher/cli/releases/latest | jq -r '.tag_name' || true)"
          if [ -z "${TAG:-}" ] || [ "${TAG}" = "null" ]; then
            TAG="$(git ls-remote --tags --refs https://github.com/rancher/cli.git | awk -F/ '{print $NF}' | sort -Vr | head -n1 || true)"
          fi
          echo "rver=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Ensure tool-versions.json exists (initialize if missing)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build/config
          if [ ! -f build/config/tool-versions.json ]; then
            jq -n \
              --arg kubectl "v1.35.0" \
              --arg oc "main" \
              --arg rancher "v2.13.1" \
              --arg go "1.25.5" \
              '{kubectl:$kubectl, oc:$oc, rancher:$rancher, go:$go}' \
              > build/config/tool-versions.json
          fi

      - name: Decide if update is needed (compare values)
        id: should_update
        shell: bash
        run: |
          set -euo pipefail
          CUR_KUBECTL="$(jq -r '.kubectl' build/config/tool-versions.json)"
          CUR_RANCHER="$(jq -r '.rancher' build/config/tool-versions.json)"
          NEW_KUBECTL="${{ steps.kver.outputs.kver }}"
          NEW_RANCHER="${{ steps.rver.outputs.rver }}"
          [ -z "${NEW_KUBECTL}" ] || [ "${NEW_KUBECTL}" = "null" ] && NEW_KUBECTL="${CUR_KUBECTL}"
          [ -z "${NEW_RANCHER}" ] || [ "${NEW_RANCHER}" = "null" ] && NEW_RANCHER="${CUR_RANCHER}"
          if [ "${CUR_KUBECTL}" != "${NEW_KUBECTL}" ] || [ "${CUR_RANCHER}" != "${NEW_RANCHER}" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "new_k=${NEW_KUBECTL}" >> "$GITHUB_OUTPUT"
            echo "new_r=${NEW_RANCHER}" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"

      - name: Update ONLY kubectl and rancher (preserve oc and go)
        if: steps.should_update.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          tmp="$(mktemp)"
          jq \
            --arg kubectl "${{ steps.should_update.outputs.new_k }}" \
            --arg rancher "${{ steps.should_update.outputs.new_r }}" \
            '.kubectl = $kubectl | .rancher = $rancher' \
            build/config/tool-versions.json > "$tmp"
          mv "$tmp" build/config/tool-versions.json

      - name: Create Pull Request
        if: steps.should_update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          title: "chore: bump tool versions (kubectl/rancher)"
          commit-message: "chore: bump tools - kubectl=${{ steps.should_update.outputs.new_k }}, rancher=${{ steps.should_update.outputs.new_r }}"
          body: |
            Automated upstream version bump:
            - kubectl: ${{ steps.should_update.outputs.new_k }} (Kubernetes stable.txt)
            - oc: (unchanged: preserved from tool-versions.json)
            - rancher: ${{ steps.should_update.outputs.new_r }} (Rancher CLI release)
            This PR was created automatically by the enterprise toolchain auto-update workflow.
          branch: "auto/bump-tools"
          labels: "automation,toolchain"
