# ------------------------------------------------------------------------------------
# Build & Release Toolchain (CLI binaries)
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> © Biosa Labs
# Builds CLI tools (kubectl, oc, rancher) for amd64 and arm64, signs and releases.
# Nightly: bakes prebuilt binaries into builder image for faster CI.
# ------------------------------------------------------------------------------------

name: Build & Release Toolchain

on:
  workflow_dispatch:
  push:
    branches: ["master"]
    paths:
      - "build/**"
      - "scripts/release/**"
      - ".github/workflows/build-toolchain.yml"
  schedule:
    - cron: "0 3 * * *" # UTC — nightly build

jobs:
  build-amd64-cross:
    name: Cross Build on AMD64 (produces amd64 & arm64 CLI tarballs)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      GO_VERSION_DEFAULT: "1.25.5"
      BUILDER_IMAGE: "ghcr.io/lorenzobiosa/ubi9-toolchain-builder:latest"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq for JSON parsing
        run: |
          sudo apt-get update -y || true
          sudo apt-get install -y jq || true

      - name: Load tool pins from JSON
        id: pins
        run: |
          set -euo pipefail
          VERSIONS_JSON="build/config/tool-versions.json"
          [ -f "$VERSIONS_JSON" ] || { echo "[ERROR] Missing $VERSIONS_JSON"; exit 1; }
          KUBECTL=$(jq -r '.kubectl' "$VERSIONS_JSON")
          OCREF=$(jq -r '.oc' "$VERSIONS_JSON")
          RANCHER=$(jq -r '.rancher' "$VERSIONS_JSON")
          FULCIO=$(jq -r '.fulcio' "$VERSIONS_JSON")
          GO_VER=$(jq -r '.go' "$VERSIONS_JSON")
          printf 'kubectl=%s\n' "$KUBECTL" >> "$GITHUB_OUTPUT"
          printf 'ocref=%s\n' "$OCREF" >> "$GITHUB_OUTPUT"
          printf 'rancher=%s\n' "$RANCHER" >> "$GITHUB_OUTPUT"
          printf 'fulcio=%s\n' "$FULCIO" >> "$GITHUB_OUTPUT"
          printf 'go=%s\n' "$GO_VER" >> "$GITHUB_OUTPUT"

      - name: Prepare output dirs and caches
        run: |
          set -euo pipefail
          mkdir -p out logs
          chmod +x build/build-tools.sh
          for d in ".cache/go-build-amd64" ".cache/go-mod-amd64" ".cache/dnf-amd64" ".cache/ccache-amd64"; do
            mkdir -p "$d"
            chmod 777 "$d"
            chmod -R u+rwX,go+rwX "$d" || true
          done

      - name: Restore Go build cache
        uses: actions/cache@v4
        with:
          path: .cache/go-build-amd64
          key: go-build-amd64-${{ steps.pins.outputs.go }}

      - name: Restore Go modules cache
        uses: actions/cache@v4
        with:
          path: .cache/go-mod-amd64
          key: go-mod-amd64-${{ steps.pins.outputs.go }}
          restore-keys: |
            go-mod-amd64-

      - name: Restore DNF cache
        uses: actions/cache@v4
        with:
          path: .cache/dnf-amd64
          key: dnf-cache-amd64-ubi9-${{ steps.pins.outputs.go }}-${{ steps.pins.outputs.ocref }}
          restore-keys: |
            dnf-cache-amd64-ubi9-

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .cache/ccache-amd64
          key: ccache-amd64-${{ steps.pins.outputs.ocref }}
          restore-keys: |
            ccache-amd64-ubi9-

      - name: Cross Build Toolchain (arm64)
        env:
          KUBECTL_VERSION: ${{ steps.pins.outputs.kubectl }}
          OCREF: ${{ steps.pins.outputs.ocref }}
          RANCHER_VERSION: ${{ steps.pins.outputs.rancher }}
          FULCIO_VERSION: ${{ steps.pins.outputs.fulcio }}
          GO_VERSION: ${{ steps.pins.outputs.go && env.GO_VERSION_DEFAULT }}
        run: |
          set -euo pipefail
          docker run -u 0 --rm --platform linux/amd64 \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL --cap-add=DAC_OVERRIDE \
            -e TOOLCHAIN_BUILDER=1 \
            -e KUBECTL_VERSION -e OCREF -e RANCHER_VERSION -e FULCIO_VERSION -e GO_VERSION \
            -e OS=linux \
            -v "$PWD/out:/out" \
            -v "$PWD/build:/build" \
            -v "$PWD/.cache/go-build-amd64:/root/.cache/go-build" \
            -v "$PWD/.cache/go-mod-amd64:/go/pkg/mod" \
            -v "$PWD/.cache/dnf-amd64:/var/cache/dnf" \
            -v "$PWD/.cache/ccache-amd64:/root/.ccache" \
            "${{ env.BUILDER_IMAGE }}" \
            bash -lc '
              export GOOS=linux
              export GOARCH=arm64
              export CGO_ENABLED=1
              export CC=clang
              export CXX=clang++
              export PKG_CONFIG_SYSROOT_DIR=/opt/sysroot/arm64
              export PKG_CONFIG_LIBDIR=/opt/sysroot/arm64/usr/lib64/pkgconfig:/opt/sysroot/arm64/usr/lib/pkgconfig
              export CGO_CFLAGS="--target=aarch64-linux-gnu --sysroot=/opt/sysroot/arm64"
              export CGO_LDFLAGS="--target=aarch64-linux-gnu --sysroot=/opt/sysroot/arm64 -fuse-ld=lld"
              export CCACHE_DISABLE=1
              bash /build/build-tools.sh linux arm64 "$GO_VERSION"
            '

      - name: Native Build Toolchain (amd64)
        env:
          KUBECTL_VERSION: ${{ steps.pins.outputs.kubectl }}
          OCREF: ${{ steps.pins.outputs.ocref }}
          RANCHER_VERSION: ${{ steps.pins.outputs.rancher }}
          FULCIO_VERSION: ${{ steps.pins.outputs.fulcio }}
          GO_VERSION: ${{ steps.pins.outputs.go && env.GO_VERSION_DEFAULT }}
        run: |
          set -euo pipefail
          docker run -u 0 --rm --platform linux/amd64 \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL --cap-add=DAC_OVERRIDE \
            -e TOOLCHAIN_BUILDER=1 \
            -e KUBECTL_VERSION -e OCREF -e RANCHER_VERSION -e FULCIO_VERSION -e GO_VERSION \
            -e OS=linux \
            -v "$PWD/out:/out" \
            -v "$PWD/build:/build" \
            -v "$PWD/.cache/go-build-amd64:/root/.cache/go-build" \
            -v "$PWD/.cache/go-mod-amd64:/go/pkg/mod" \
            -v "$PWD/.cache/dnf-amd64:/var/cache/dnf" \
            -v "$PWD/.cache/ccache-amd64:/root/.ccache" \
            "${{ env.BUILDER_IMAGE }}" \
            bash -lc '
              export GOOS=linux
              export GOARCH=amd64
              export CGO_ENABLED=1
              export CC=gcc
              export CXX=g++
              bash /build/build-tools.sh linux amd64 "$GO_VERSION"
            '

      - name: Verify artifacts exist
        run: |
          set -euo pipefail
          for a in amd64 arm64; do
            ART="out/tools-linux-${a}.tar.gz"
            [ -f "${ART}" ] || { echo "::error title=Artifact missing::Expected ${ART}"; ls -la out; exit 1; }
            ls -lh "${ART}"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tools-linux
          path: |
            out/tools-linux-amd64.tar.gz
            out/tools-linux-arm64.tar.gz
          overwrite: true
          if-no-files-found: error
          compression-level: 6
