# ------------------------------------------------------------------------------------
# PR Governance — Validation & Automation
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> © Biosa Labs
# Enforces PR hygiene (checklist, semantic title) and auto-labels + issue links.
# ------------------------------------------------------------------------------------

name: PR Governance

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-and-assign:
    name: Validate PR checklist, title, labels & issue links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI & jq
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y gh jq
          gh auth status

      - name: Extract PR body and title (robust)
        id: pr_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PR="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          DATA="$(gh api repos/${REPO}/pulls/${PR})"
          PR_TITLE="$(jq -r '.title // ""' <<< "${DATA}")"
          PR_BODY="$(jq -r '.body // ""' <<< "${DATA}")"
          PR_TITLE_TRIMMED="$(printf '%s' "${PR_TITLE}" | sed 's/^[[:space:]]\+//; s/[[:space:]]\+$//')"
          {
            echo "PR_TITLE=${PR_TITLE_TRIMMED}"
            echo 'PR_BODY<<EOF'
            echo "${PR_BODY}"
            echo 'EOF'
          } >> "$GITHUB_ENV"

      - name: Validate checklist items
        env:
          PR_BODY: ${{ env.PR_BODY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          LC_ALL=C
          REQUIRED_ITEMS=(
            "Code follows repository style and conventions"
            "Tests added / updated to cover changes"
            "Documentation updated if needed"
            "CI passes on all relevant platforms"
            "Changes linked to at least one issue"
            "PR title follows semantic pattern"
          )
          FAILED=0
          for ITEM in "${REQUIRED_ITEMS[@]}"; do
            if ! printf '%s\n' "${PR_BODY}" | grep -iEq "^[[:space:]]*[-*][[:space:]]*\[[xX]\][[:space:]]*${ITEM}"; then
              echo "❌ Checklist item not completed: ${ITEM}"
              FAILED=1
            fi
          done
          if [ "${FAILED}" -eq 1 ]; then
            gh pr comment "${{ github.event.pull_request.number }}" \
              --body "⚠️ Some required checklist items appear missing or unchecked. Please complete the PR checklist in the template."
            exit 1
          fi

      - name: Enforce semantic PR title
        env:
          PR_TITLE: ${{ env.PR_TITLE }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          LC_ALL=C
          PATTERN='^\[(Feature|Bug|Security|Docs|CI|Tooling|Breaking-Change)\]\s.+'
          if ! printf '%s' "${PR_TITLE}" | grep -E "${PATTERN}" >/dev/null; then
            gh pr comment "${{ github.event.pull_request.number }}" \
              --body "⚠️ PR title must follow the semantic pattern: \`\[Type] Your concise description\` (Types: Feature, Bug, Security, Docs, CI, Tooling, Breaking-Change)."
            exit 1
          fi

      - name: Auto-assign labels based on PR title
        env:
          PR_TITLE: ${{ env.PR_TITLE }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PR=${{ github.event.pull_request.number }}
          case "${PR_TITLE}" in
            "[Feature]"*)  gh pr edit "${PR}" --add-label "feature" ;;
            "[Bug]"*)      gh pr edit "${PR}" --add-label "bug" ;;
            "[Security]"*) gh pr edit "${PR}" --add-label "security" ;;
            "[Docs]"*)     gh pr edit "${PR}" --add-label "docs" ;;
            "[CI]"*)       gh pr edit "${PR}" --add-label "ci" ;;
            "[Tooling]"*)  gh pr edit "${PR}" --add-label "tooling" ;;
            "[Breaking-Change]"*) gh pr edit "${PR}" --add-label "breaking-change" ;;
          esac

      - name: Auto-link to related issues
        env:
          PR_BODY: ${{ env.PR_BODY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PR=${{ github.event.pull_request.number }}
          ISSUE_NUMBERS=$(printf '%s' "${PR_BODY}" | grep -oE '#[0-9]+' | tr -d '#')
          for NUM in ${ISSUE_NUMBERS}; do
            gh pr comment "${PR}" --body "Linked to issue #${NUM}"
            gh issue comment "${NUM}" --body "PR #${PR} references this issue"
          done

      - name: Success
        run: echo "✅ PR passes checks; labels & issue links applied."
