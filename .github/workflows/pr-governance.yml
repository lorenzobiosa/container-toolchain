# ------------------------------------------------------------------------------
# PR Governance — Validation & Automation (GitHub Actions Workflow)
# Purpose:
#   - Enforce PR hygiene and alignment with release note categories
#   - Validate mandatory checklist items from PR template (robust parsing)
#   - Enforce semantic PR title pattern (enterprise-approved types)
#   - Auto-apply labels based on semantic title
#   - Link PR to referenced issues for traceability
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> © Biosa Labs
#
# Triggers:
#   - On PR open/edit/reopen/synchronize to keep state consistent across updates
#
# Security & Permissions:
#   - Minimal scopes: read repo contents; write issues/pull-requests only
#   - No privilege escalation or publishing beyond labels/comments
#
# Notes:
#   - Ensure the repository has a PR template (.github/PULL_REQUEST_TEMPLATE.md)
#     that contains the required checklist items.
#   - Ensure .github/release.yml exists with categories consistent with labels.
#   - This workflow uses robust JSON extraction via `gh api` and tolerant regexes
#     to minimize false negatives in checklist validation.
# ------------------------------------------------------------------------------

name: PR Governance

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  validate-and-assign:
    name: Validate PR checklist, title, labels & issue links
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------------------
      # Checkout is kept for potential future extensions (e.g., local policies)
      # ------------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      # ------------------------------------------------------------------------
      # Install GitHub CLI and jq for robust PR/Issue operations and JSON parsing
      # Authentication uses the ephemeral GITHUB_TOKEN provided by the runner.
      # ------------------------------------------------------------------------
      - name: Install GitHub CLI & jq
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y gh jq
          # Verify auth context
          gh auth status

      # ------------------------------------------------------------------------
      # Extract PR title and body safely using REST API (`gh api`).
      # - Trim title to avoid regex false negatives due to trailing spaces.
      # - Export body via multiline GITHUB_ENV block to preserve content.
      # ------------------------------------------------------------------------
      - name: Extract PR body and title (robust)
        id: pr_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PR="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          DATA="$(gh api repos/${REPO}/pulls/${PR})"

          PR_TITLE="$(jq -r '.title // ""' <<< "${DATA}")"
          PR_BODY="$(jq -r '.body  // ""' <<< "${DATA}")"

          # Trim leading/trailing whitespace from title
          PR_TITLE_TRIMMED="$(printf '%s' "${PR_TITLE}" | sed 's/^[[:space:]]\+//; s/[[:space:]]\+$//')"

          {
            echo "PR_TITLE=${PR_TITLE_TRIMMED}"
            echo 'PR_BODY<<EOF'
            echo "${PR_BODY}"
            echo 'EOF'
          } >> "$GITHUB_ENV"

      # ------------------------------------------------------------------------
      # Validate the checklist items (tolerant regex):
      # - Accepts "-" or "*" bullets
      # - Accepts `[x]` or `[X]`
      # - Ignores leading spaces and capitalization differences
      # ------------------------------------------------------------------------
      - name: Validate checklist items
        env:
          PR_BODY: ${{ env.PR_BODY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          LC_ALL=C

          REQUIRED_ITEMS=(
            "Code follows repository style and conventions"
            "Tests added / updated to cover changes"
            "Documentation updated if needed"
            "CI passes on all relevant platforms"
            "Changes linked to at least one issue"
            "PR title follows semantic pattern"
          )

          FAILED=0
          for ITEM in "${REQUIRED_ITEMS[@]}"; do
            # Matches lines like: "- [x] ITEM" or "* [X] ITEM" with optional spaces
            if ! printf '%s\n' "$PR_BODY" | grep -iEq "^[[:space:]]*[-*][[:space:]]*\[[xX]\][[:space:]]*$ITEM"; then
              echo "❌ Checklist item not completed: $ITEM"
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "⚠️ Some required checklist items appear missing or unchecked. Please complete the PR checklist in the template."
            exit 1
          fi

      # ------------------------------------------------------------------------
      # Enforce semantic PR title pattern (trimmed):
      # Accepted types:
      #   [Feature], [Bug], [Security], [Docs], [CI], [Tooling], [Breaking-Change]
      # ------------------------------------------------------------------------
      - name: Enforce semantic PR title
        env:
          PR_TITLE: ${{ env.PR_TITLE }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          LC_ALL=C
          PATTERN='^\[(Feature|Bug|Security|Docs|CI|Tooling|Breaking-Change)\]\s.+'
          if ! printf '%s' "$PR_TITLE" | grep -E "$PATTERN" >/dev/null; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "⚠️ PR title must follow the semantic pattern: \`[Type] Your concise description\` (Types: Feature | Bug | Security | Docs | CI | Tooling | Breaking-Change)."
            exit 1
          fi

      # ------------------------------------------------------------------------
      # Auto-assign labels based on the semantic title.
      # Ensure labels exist in the repository: feature, bug, security, docs, ci,
      # tooling, breaking-change.
      # ------------------------------------------------------------------------
      - name: Auto-assign labels based on PR title
        env:
          PR_TITLE: ${{ env.PR_TITLE }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PR=${{ github.event.pull_request.number }}
          case "$PR_TITLE" in
            \[Feature\]*)          gh pr edit "$PR" --add-label "feature" ;;
            \[Bug\]*)              gh pr edit "$PR" --add-label "bug" ;;
            \[Security\]*)         gh pr edit "$PR" --add-label "security" ;;
            \[Docs\]*)             gh pr edit "$PR" --add-label "docs" ;;
            \[CI\]*)               gh pr edit "$PR" --add-label "ci" ;;
            \[Tooling\]*)          gh pr edit "$PR" --add-label "tooling" ;;
            \[Breaking-Change\]*)  gh pr edit "$PR" --add-label "breaking-change" ;;
          esac

      # ------------------------------------------------------------------------
      # Auto-link to related issues:
      # Detect '#123' patterns and cross-comment for traceability.
      # ------------------------------------------------------------------------
      - name: Auto-link to related issues
        env:
          PR_BODY: ${{ env.PR_BODY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          PR=${{ github.event.pull_request.number }}
          ISSUE_NUMBERS=$(printf '%s' "$PR_BODY" | grep -oE '#[0-9]+' | tr -d '#')
          for NUM in $ISSUE_NUMBERS; do
            gh pr comment "$PR" --body "Linked to issue #$NUM"
            gh issue comment "$NUM" --body "PR #$PR references this issue"
          done

      # ------------------------------------------------------------------------
      # Success marker
      # ------------------------------------------------------------------------
      - name: Success
        run: echo "✅ PR passes checks; labels & issue links applied."
