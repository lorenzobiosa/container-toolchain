# ------------------------------------------------------------------------------------
# Cosign Sign & Verify
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> Â© Biosa Labs
# Signs by digest (keyless OIDC) and verifies certificate identity binding.
# ------------------------------------------------------------------------------------

name: Cosign Sign & Verify

on:
  workflow_call:
    inputs:
      image_ref: { required: true, type: string } # e.g., ghcr.io/<owner>/<image>:tag
      digest: { required: true, type: string } # immutable content digest
      workflow_file: { required: true, type: string } # e.g., .github/workflows/sign-verify.yml

jobs:
  cosign:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # OIDC for keyless
      contents: read
      packages: read
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Sign (keyless) by digest
        env:
          COSIGN_YES: "true"
        run: |
          set -euo pipefail
          cosign sign "${{ inputs.image_ref }}@${{ inputs.digest }}"

      - name: Verify (strict identity via OIDC)
        run: |
          set -euo pipefail
          IDENTITY="${{ github.server_url }}/${{ github.repository }}/${{ inputs.workflow_file }}@${{ github.ref }}"
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity "${IDENTITY}" \
            "${{ inputs.image_ref }}@${{ inputs.digest }}"
