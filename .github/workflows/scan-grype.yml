# ------------------------------------------------------------------------------------
# Anchore/Grype Vulnerability Scan
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> Â© Biosa Labs
# Scans a container image using Grype and uploads SARIF to GitHub Code Scanning.
# ------------------------------------------------------------------------------------

name: Scan (Grype)

on:
  workflow_call:
    inputs:
      image_ref:
        description: "Image reference to scan (e.g., ghcr.io/<owner>/<image>:tag)"
        required: true
        type: string
      fail_on:
        description: "Severity cutoff that should fail the build (e.g., high, critical)"
        required: true
        type: string

jobs:
  grype:
    runs-on: ubuntu-latest
    permissions:
      security-events: write # SARIF upload
    steps:
      - name: Scan image with Grype (Anchore)
        id: grype
        uses: anchore/scan-action@v6
        with:
          image: ${{ inputs.image_ref }}
          fail-build: true
          severity-cutoff: ${{ inputs.fail_on }} # values: negligible|low|medium|high|critical
          output-format: sarif

      - name: Upload SARIF (Grype) to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}

      - name: Upload SARIF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: grype-${{ inputs.image_ref }}.sarif
          path: ${{ steps.grype.outputs.sarif }}
