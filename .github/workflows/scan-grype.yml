name: Scan (Grype)

on:
  workflow_call:
    inputs:
      image_ref:
        description: "Image reference to scan (e.g., ghcr.io/<owner>/<image>:tag)"
        required: true
        type: string
      fail_on:
        description: "Severity cutoff that should fail the build (e.g., high, critical)"
        required: true
        type: string

jobs:
  grype:
    runs-on: ubuntu-latest
    permissions:
      security-events: write # required for SARIF upload
    steps:
      - name: Scan image with Grype (Anchore)
        id: grype
        uses: anchore/scan-action@v6
        with:
          image: ${{ inputs.image_ref }}
          fail-build: true
          severity-cutoff: ${{ inputs.fail_on }} # valid values: low|medium|high|critical
          output-format: sarif

      - name: Upload SARIF (Grype) to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
