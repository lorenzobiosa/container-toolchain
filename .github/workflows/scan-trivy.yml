# ------------------------------------------------------------------------------------
# Trivy Vulnerability Scan
# ------------------------------------------------------------------------------------
# Author: Lorenzo Biosa <lorenzo@biosa-labs.com> Â© Biosa Labs
# Scans a container image and uploads SARIF to GitHub Code Scanning.
# ------------------------------------------------------------------------------------

name: Scan (Trivy)

on:
  workflow_call:
    inputs:
      image_ref: { required: true, type: string }
      fail_on: { required: true, type: string }
      output_sarif: { required: false, type: boolean, default: true }

jobs:
  trivy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # SARIF upload
    steps:
      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ inputs.image_ref }}
          format: "sarif"
          output: "trivy.sarif"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: ${{ inputs.fail_on }}
          exit-code: "1"

      - name: Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy.sarif

      - name: Upload SARIF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ inputs.image_ref }}
          path: trivy.sarif
