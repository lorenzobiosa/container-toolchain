name: Build & Push

on:
  workflow_call:
    inputs:
      base: { required: true, type: string }
      tag: { required: true, type: string }
      image_name: { required: true, type: string } # ghcr.io/<owner>/<image>
      title: { required: true, type: string }
      description: { required: true, type: string }
      vendor: { required: true, type: string }
      licenses: { required: true, type: string }
    outputs:
      digest:
        description: "Image content digest"
        value: ${{ jobs.build.outputs.digest }}
      tag:
        description: "Tag propagated"
        value: ${{ inputs.tag }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    outputs:
      digest: ${{ steps.out.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      # QEMU NON NECESSARIO per single-arch amd64 → RIMOSSO
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
        # facoltativo: install: true se vuoi che `docker buildx` sia il default
        # with:
        #   install: true

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute build metadata
        id: meta
        run: |
          echo "revision=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"
          echo "version=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Build & Push (GHCR) — provenance+SBOM
        id: buildpush
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/builder/Dockerfile
          # Single arch ONLY
          platforms: linux/amd64
          push: true
          tags: |
            ${{ inputs.image_name }}:${{ inputs.tag }}
            ${{ inputs.image_name }}:latest
          build-args: |
            BASE_IMAGE=${{ inputs.base }}
            IMAGE_TITLE=${{ inputs.title }}
            IMAGE_DESCRIPTION=${{ inputs.description }}
            IMAGE_VENDOR=${{ inputs.vendor }}
            IMAGE_LICENSES=${{ inputs.licenses }}
            VCS_REF=${{ steps.meta.outputs.revision }}
            BUILD_DATE=${{ steps.meta.outputs.created }}
            IMAGE_VERSION=${{ steps.meta.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: mode=max
          sbom: true

      - name: Export digest
        id: out
        run: |
          echo "digest=${{ steps.buildpush.outputs.digest }}" >> "$GITHUB_OUTPUT"
